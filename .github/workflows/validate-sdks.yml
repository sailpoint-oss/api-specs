name: "Validate SDK Builds"

on:
  pull_request:
    branches:
      - main
    paths:
      - idn/**
  workflow_dispatch:

concurrency:
  group: validate-sdks-${{ github.ref }}
  cancel-in-progress: true

env:
  SAIL_CLIENT_ID: ${{ secrets.SDK_TEST_TENANT_CLIENT_ID }}
  SAIL_CLIENT_SECRET: ${{ secrets.SDK_TEST_TENANT_CLIENT_SECRET }}
  SAIL_BASE_URL: ${{ secrets.SDK_TEST_TENANT_BASE_URL }}

jobs:
  validate-go:
    name: Validate Go SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Go SDK
        uses: actions/checkout@v6
        with:
          repository: sailpoint-oss/golang-sdk
          ref: main

      - name: Checkout API Specs (PR branch)
        uses: actions/checkout@v6
        with:
          path: api-specs

      - name: Build and Test Go SDK
        uses: sailpoint-oss/golang-sdk/.github/actions/build-sdk@main
        with:
          api-specs-path: api-specs

  validate-typescript:
    name: Validate TypeScript SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout TypeScript SDK
        uses: actions/checkout@v6
        with:
          repository: sailpoint-oss/typescript-sdk
          ref: main

      - name: Checkout API Specs (PR branch)
        uses: actions/checkout@v6
        with:
          path: api-specs

      - name: Build and Test TypeScript SDK
        uses: sailpoint-oss/typescript-sdk/.github/actions/build-sdk@main
        with:
          api-specs-path: api-specs

  validate-python:
    name: Validate Python SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Python SDK
        uses: actions/checkout@v6
        with:
          repository: sailpoint-oss/python-sdk
          ref: main

      - name: Checkout API Specs (PR branch)
        uses: actions/checkout@v6
        with:
          path: api-specs

      - name: Build and Test Python SDK
        uses: sailpoint-oss/python-sdk/.github/actions/build-sdk@main
        with:
          api-specs-path: api-specs

  validate-powershell:
    name: Validate PowerShell SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PowerShell SDK
        uses: actions/checkout@v6
        with:
          repository: sailpoint-oss/powershell-sdk
          ref: main

      - name: Checkout API Specs (PR branch)
        uses: actions/checkout@v6
        with:
          path: api-specs

      - name: Build and Test PowerShell SDK
        uses: sailpoint-oss/powershell-sdk/.github/actions/build-sdk@main
        with:
          api-specs-path: api-specs

  validate-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: [validate-go, validate-typescript, validate-python, validate-powershell]
    if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'timed_out')) }}
    steps:
      - name: Invoke GithubNotificationsFunction Lambda
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "workflowName": "${{ github.job }}",
              "repositoryName": "${{ github.event.repository.name }}",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' \
            "${{ secrets.NOTIFICATIONS_FUNCTION_URL }}"
