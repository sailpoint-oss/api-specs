name: "Notify SDK Repos of Spec Changes"

on:
  push:
    branches:
      - main
    paths:
      - idn/**
  workflow_dispatch:

concurrency:
  group: notify-sdks
  cancel-in-progress: true

jobs:
  dispatch:
    name: Dispatch to SDK repos
    runs-on: ubuntu-latest
    steps:
      - name: Notify Go SDK
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.DEVREL_SERVICE_TOKEN }}
          repository: sailpoint-oss/golang-sdk
          event-type: api-specs-updated

      - name: Notify TypeScript SDK
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.DEVREL_SERVICE_TOKEN }}
          repository: sailpoint-oss/typescript-sdk
          event-type: api-specs-updated

      - name: Notify Python SDK
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.DEVREL_SERVICE_TOKEN }}
          repository: sailpoint-oss/python-sdk
          event-type: api-specs-updated

      - name: Notify PowerShell SDK
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.DEVREL_SERVICE_TOKEN }}
          repository: sailpoint-oss/powershell-sdk
          event-type: api-specs-updated

  dispatch-failure:
    name: Notify on failure
    runs-on: ubuntu-latest
    needs: dispatch
    if: ${{ always() && (needs.dispatch.result == 'failure' || needs.dispatch.result == 'timed_out') }}
    steps:
      - name: Invoke GithubNotificationsFunction Lambda
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "workflowName": "${{ github.job }}",
              "repositoryName": "${{ github.event.repository.name }}",
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' \
            "${{ secrets.NOTIFICATIONS_FUNCTION_URL }}"
